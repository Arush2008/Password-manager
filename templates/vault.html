<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Page</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://site-assets.fontawesome.com/releases/v6.7.2/css/all.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css"
    />
    <script src="{{ url_for('static', filename='script.js') }}"></script>
  </head>
  <body class="vault_page">
    
    <!-- Top Bar -->
    <div class="top_part">
      <div class="top-left">
        <button class="icon-button menu-toggle" id="menuToggle" aria-label="Open menu" aria-controls="sidebar" aria-expanded="false">
          <i class="fa-regular fa-bars"></i>
        </button>
        <a class="logo-page2">webi</a>
        <div class="search-bar">
          <input type="text" placeholder="Search..." />
          <button type="submit">Search</button>
        </div>
      </div>
      <div class="top-right">
        <button class="icon-button notification">
          <i class="fa-regular fa-bell"></i>
        </button>
        <button class="icon-button settings">
          <i class="fa-regular fa-gear"></i>
        </button>
        <div class="profile-wrapper">
          <div class="profile-avatar" id="profileButton" aria-haspopup="true" aria-expanded="false">
            <i class="fa-regular fa-user"></i>
          </div>
          <div class="profile-dropdown" id="profileDropdown" role="menu">
            <a class="dropdown-item" href="{{ url_for('views.logout') }}">
              <i class="fa-regular fa-right-from-bracket"></i>
              <span>Logout</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar" aria-hidden="false">
      <div class="sidebar-content">
        <div class="sidebar_titles">Categories</div>

        <!-- Default categories -->
        <a href="{{url_for('views.vault', category='All Passwords')}}">
          <div class="sidebar-text {%if category == 'All Passwords'%}active{% endif %}">
            <i class="fa-regular fa-lock-keyhole"></i>
            <span>All Passwords</span>
          </div>
        </a>

        {% for c in default_categories if c != 'All Passwords' %}
          <a href="{{ url_for('views.vault', category=c) }}">
            <div class="sidebar-text {% if category == c %}active{% endif %}">
              {% if c == 'Personal' %}
                <i class="ri-user-line"></i>
              {% elif c == 'Work' %}
                <i class="fa-regular fa-briefcase"></i>
              {% elif c == 'Finance' %}
                <i class="fa-regular fa-wallet"></i>
              {% elif c == 'Gaming' %}
                <i class="fa-regular fa-gamepad-modern"></i>
              {% else %}
                <i class="fa-regular fa-folder"></i>
              {% endif %}
              <span>{{ c }}</span>
            </div>
          </a>
        {% endfor %}

        <!-- Custom categories -->
        {% for c in custom_categories %}
          <a href="{{ url_for('views.vault', category=c) }}">
            <div class="sidebar-text {% if category == c %}active{% endif %}">
              <i class="fa-regular fa-folder"></i>
              <span>{{ c }}</span>
            </div>
          </a>
        {% endfor %}

        <a href="{{ url_for('views.vault', category=category, popup='add-category') }}">
        <div class="sidebar-text">
          <i class="fa-solid fa-plus"></i>
          <span>Add Category</span>
        </div>
        </a>

        <!-- Invisible divider between Categories and Quick Actions -->
        <hr class="invisible-divider" />

        <!-- Quick Actions Section -->
        <div class="sidebar_titles">Quick Actions</div>

        <a href="{{ url_for('views.vault', category=category, popup='password-generator') }}">
          <div class="sidebar-text" id="password-generator-btn">
            <i class="fa-regular fa-key"></i>
            <span>Password Generator</span>
          </div>
        </a>

        <a href="{{ url_for('views.vault', category=category, popup='add-new-entry') }}">
          <div class="sidebar-text">
            <i class="fa-regular fa-circle-plus"></i>
            <span>Add New Entry</span>
          </div>
        </a>

        <div class="sidebar-text">
          <i class="fa-regular fa-shield-check"></i>
          <span>Security Check</span>
        </div>

        <div class="sidebar-text">
          <i class="ri-refresh-line"></i>
          <span>Sync Now</span>
        </div>
      </div>
    </div>
  <div class="backdrop" id="sidebarBackdrop" hidden></div>

    <!-- Main Content -->
    <div class="main-content">
      {% if category == 'All Passwords' %}
        <h2>All Passwords</h2>
      {% else %}
        <h2>{{ category }} Passwords</h2>
      {% endif %}
      
      <!-- Display saved passwords -->
      {% if passwords %}
        <div class="password-list password-grid">
          {% for password in passwords %}
            {% set plen = password.site_password|length %}
            <div class="password-card">
              <!-- Row 1: index left, category right -->
              <div class="card-row first-row">
                <span class="index-dot">{{ loop.index }}</span>
                <span class="category-chip">{{ password['category'] }}</span>
              </div>

              <!-- Row 2: title/subtitle left, actions right -->
              <div class="card-row second-row">
                <div class="title-block">
                  <div class="site-title">{{ password.site_name }}</div>
                  <div class="site-subtitle">{{ password.site_username }}</div>
                </div>
                <div class="card-actions">
                  <a href="{{ url_for('views.vault', category=category, popup='edit-entry', id=password['id']) }}" title="Edit"><i class="fa-regular fa-pen-to-square"></i></a>
                  <a class="btn-delete" href="{{ url_for('views.delete_password', id=password['id'], category=category) }}" title="Delete" onclick="return confirm('Are you sure you want to delete this password?');"><i class="fa-regular fa-trash"></i></a>
                </div>
              </div>

              <!-- Row 3: password field with eye inside, copy on right -->
              <div class="card-row third-row">
                <div class="password-secret" data-password="{{ password.site_password|e }}">
                  <span class="pw-dots">{{ "â€¢" * plen }}</span>
                  <span class="pw-text" style="display:none;"></span>
                  <button type="button" class="pw-visibility-btn" aria-label="Show password">
                    <i class="fa-regular fa-eye"></i>
                  </button>
                </div>
                <button type="button" class="copy-btn-card" aria-label="Copy password">
                  <i class="fa-regular fa-clipboard"></i>
                </button>
              </div>

              <!-- Row 4: link (fixed height row; blank if none) -->
              <div class="card-row fourth-row">
                {% if password['url'] %}
                  <div class="link-line">
                    <span class="link-label">Link:</span>
                    <a class="link-text" href="{{ password['url']|e }}" target="_blank" rel="noopener noreferrer">{{ password['url'] }}</a>
                  </div>
                {% else %}
                  <div class="link-line"><span class="link-label"></span><span class="link-text"></span></div>
                {% endif %}
              </div>

              <!-- Row 5: notes line (fixed height row; blank if none) -->
              <div class="card-row fifth-row">
                {% if password['notes'] %}
                  <div class="notes-text">Note: {{ password['notes'] }}</div>
                {% else %}
                  <div class="notes-text"></div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p>No passwords saved in this category yet. <a href="{{ url_for('views.vault', category=category, popup='add-new-entry') }}">Add your first password entry!</a></p>
      {% endif %}
    </div>

    <!------------------------------------- Password Generator Popup ------------------------------------->
    {% if show_password_generator_popup %}
    <div class="popup-overlay">
      <div class="popup-content">
        <a href="{{ url_for('views.vault', category=category) }}" class="close-btn">&times;</a>

        <!-- Generated Password Display Section -->
        <div class="password-display-section">
          <label for="generated-password">Generated Password:</label>
          <div class="password-output-container">
            <div class="password-output">
              <input type="text" id="generated-password" class="password-output-input" value="{{ generated_password }}" readonly>
              <button type="button" class="refresh-btn" title="Generate new password" onclick="generateNewPassword()">
                <i class="ri-refresh-line"></i>
              </button>
              <button type="button" class="copy-btn" title="Copy Password" onclick="navigator.clipboard.writeText(document.getElementById('generated-password').value)">
                <i class="fa-regular fa-copy"></i>
              </button>
            </div>
          </div>
          
          <!-- Password Length Controls -->
          <div class="password-length-section">
            <label for="password-length">Password Length: <span id="length-display">{{ password_length }}</span></label>
            <div class="length-controls">
              <a href="#" class="length-btn {% if password_length <= 8 %}disabled{% endif %}" onclick="decreaseLength(event)">-</a>
              <input type="range" min="8" max="32" value="{{ password_length }}" class="slider" id="myRange">
              <a href="#" class="length-btn {% if password_length >= 32 %}disabled{% endif %}" onclick="increaseLength(event)">+</a>
            </div>

            <!-- Password Options -->
            <div class="password-options-section">
              <div class="options">
                <label><input type="checkbox" name="uppercase" checked> Uppercase Letters <span class="option-example">(A-Z)</span></label>
                <label><input type="checkbox" name="lowercase" checked> Lowercase Letters <span class="option-example">(a-z)</span></label>
                <label><input type="checkbox" name="numbers" checked> Numbers <span class="option-example">(0-9)</span></label>
                <label><input type="checkbox" name="symbols" checked> Special Characters <span class="option-example">(!@#$%^&*)</span></label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!------------------------------------- Add New Entry Popup ------------------------------------->
    {% if show_new_entry_popup %}
    <div class="popup-2-overlay">
      <div class="popup-2-content">
        <h2>Add New Entry</h2>
        <a href="{{ url_for('views.vault', category=category) }}" class="close-btn">&times;</a>
        <div>
          <form method="POST" action="{{ url_for('views.vault') }}">
            <label for="title" class="text-label">Website/App</label><br>
            <input type="text" id="title" name="title" class="text-input" maxlength="15" required><br>

            <label for="username" class="text-label">Username/Email</label><br>
            <input type="text" id="username" name="username" class="text-input" maxlength="15" required><br>

            <label for="password" class="text-label">Password</label><br>
            <input type="password" id="password" name="password" class="text-input" minlength="8" required><br>

            <label for="url" class="text-label">Website URL (optional)</label><br>
            <input type="url" id="url" name="url" class="text-input" placeholder="https://example.com"><br>

            <label for="category" class="text-label">Category</label><br>
            <select id="category" name="category" class="text-input">
              {% for c in default_categories if c != 'All Passwords' %}
                <option value="{{ c }}" {% if category == c %}selected{% endif %}>{{ c }}</option>
              {% endfor %}
              {% for c in custom_categories %}
                <option value="{{ c }}" {% if category == c %}selected{% endif %}>{{ c }}</option>
              {% endfor %}
            </select><br>

            <label for="notes" class="text-label">Notes (optional)</label><br>
            <textarea id="notes" name="notes" class="text-input" maxlength="50"></textarea><br>

            <input type="submit" id="save-password-btn" name="save-password-btn" value="Save Password">
            <a href="{{ url_for('views.vault', category=category) }}" class="cancel-btn">Cancel</a>
          </form>
        </div>
      </div>
    </div>
    {% endif %}

    <!------------------------------------- Edit Entry Popup ------------------------------------->

    {% if show_edit_entry_popup %}
    <div class="popup-2-overlay">
      <div class="popup-2-content">
        <h2>Edit Entry</h2>
        <a href="{{ url_for('views.vault', category=category) }}" class="close-btn">&times;</a>
        <div>
          <form method="POST" action="{{ url_for('views.vault') }}">
            <input type="hidden" name="password_id" value="{{ edit_password_data['id'] }}">
            
            <label for="title" class="text-label">Website/App</label><br>
            <input type="text" id="title" name="title" class="text-input" value="{{ edit_password_data['site_name'] }}" maxlength="15" required><br>

            <label for="username" class="text-label">Username/Email</label><br>
            <input type="text" id="username" name="username" class="text-input" value="{{ edit_password_data['site_username'] }}" maxlength="15" required><br>

            <label for="password" class="text-label">Password</label><br>
            <div class="password-field-container">
              <input type="password" id="password" name="password" class="text-input" value="{{ edit_password_data['site_password'] }}" minlength="8" required>
              <button type="button" class="password-toggle-link" onclick="togglePassword()">
                <i class="ri-eye-line" id="toggle-icon"></i>
              </button>
            </div><br>

            <label for="url" class="text-label">Website URL (optional)</label><br>
            <input type="url" id="url" name="url" class="text-input" value="{{ edit_password_data['url'] or '' }}" placeholder="https://example.com"><br>

            <label for="category" class="text-label">Category</label><br>
            <select id="category" name="category" class="text-input">
              {% for c in default_categories if c != 'All Passwords' %}
                <option value="{{ c }}" {% if edit_password_data['category']==c %}selected{% endif %}>{{ c }}</option>
              {% endfor %}
              {% for c in custom_categories %}
                <option value="{{ c }}" {% if edit_password_data['category']==c %}selected{% endif %}>{{ c }}</option>
              {% endfor %}
            </select><br>

            <label for="notes" class="text-label">Notes (optional)</label><br>
            <textarea id="notes" name="notes" class="text-input" maxlength="50">{{ edit_password_data['notes'] or '' }}</textarea><br>

            <input type="submit" id="save-password-btn" name="save-password-btn" value="Update Password">
            <a href="{{ url_for('views.vault', category=category) }}" class="cancel-btn">Cancel</a>
          </form>
        </div>
      </div>
    </div>
    {% endif %}

    <!------------------------------------- Add Category Popup ------------------------------------->
    {% if show_add_category_popup %}
    <div class="popup-2-overlay">
      <div class="popup-2-content">
        <h2>Add Category</h2>
        <a href="{{ url_for('views.vault', category=category) }}" class="close-btn">&times;</a>
        <div>
          <form id="add-category-form">
            <label for="cat-name" class="text-label">Category Name</label><br>
            <input type="text" id="cat-name" name="name" class="text-input" maxlength="20" required><br>
            <button type="submit" id="save-category-btn" class="primary-btn" style="width:auto;">Add</button>
            <a href="{{ url_for('views.vault', category=category) }}" class="cancel-btn">Cancel</a>
          </form>
        </div>
      </div>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        const form = document.getElementById('add-category-form');
        if (!form) return;
        form.addEventListener('submit', async function(e){
          e.preventDefault();
          const fd = new FormData(form);
          try {
            const res = await fetch("{{ url_for('views.add_category') }}", {
              method: 'POST',
              body: fd
            });
            const data = await res.json();
            if (!res.ok || !data.ok) {
              alert(data.error || 'Failed to add category');
              return;
            }
            // go to the new category
            const newCat = data.name;
            window.location.href = `{{ url_for('views.vault') }}?category=${encodeURIComponent(newCat)}`;
          } catch (err) {
            alert('Error adding category');
          }
        });
      });
    </script>
    {% endif %}

  </body>
</html>